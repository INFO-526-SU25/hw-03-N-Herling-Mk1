```{r}
#| label: label-me-5a
#| fig.width: 10   # width in inches
#| fig.height: 10   # height in inches

# Define response labels
response_labels <- c(
  resp_safety = "Vaccine is safe",
  resp_feel_safe_at_work = "Feel safer\n at work",
  resp_concern_safety = "Concern about \nvaccine safety",
  resp_confidence_science = "Confidence in \nscientific vetting",
  resp_trust_info = "Trust in \nvaccine info",
  resp_will_recommend = "Will recommend\nvaccine"
)

# - likert scores
likert_scores <- c(
"1" = "Strongly Agree", 
"2" = "Somewhat Agree" , 
"3" = "Neither Agree Nor Disagree", 
"4" = "Somewhat Disagree", 
"5" = "Strongly Disagree"
)

library(ggplot2)
library(dplyr)
library(forcats)
library(viridis)

# Use your viridis color palette (defined earlier)
my_turquoise_to_yellow <- viridis(
  12,                # Generate 10 colors in total from the palette
  begin = 0.25,      # Start slightly above the darkest purple (~turquoise range)
  end = 0.85,         # Stop before reaching full yellow (closer to yellow-green)
  option = "viridis" # Use the default "viridis" palette (good for colorblind users)
)[
  c(1, 3, 5, 7, 9, 11)   # Select specific colors to get a visually spaced gradient:
                      # from start (turquoise) to near end (yellow-green) [not offset]
]


# 1. Collapse ALL explanatory categories: one mean per response variable
covid_summary_by_response <- covid_survey_longer |>
  group_by(response) |>
  summarise(
    mean = mean(response_value, na.rm = TRUE),
    .groups = "drop"
  )

# 2. Compute grand mean across all response items
grand_mean <- mean(covid_summary_by_response$mean, na.rm = TRUE)

# 3. Add centered mean
covid_summary_by_response <- covid_summary_by_response |>
  mutate(
    centered_mean = mean - grand_mean,
    response_label = response_labels[response]
  )

# 4. Plot — grouped by response question
g_diverge <- ggplot(covid_summary_by_response, aes(
  x = centered_mean,
  y = fct_reorder(response_label, centered_mean)
)) +
  geom_col(fill = "#21908CFF", width = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray30", linewidth = 0.8) +
  geom_vline(xintercept = 0, color = "#F72585", linewidth = 1) +

  # Grand Mean label (text)
  annotate(
    "text",
    x = min(covid_summary_by_response$centered_mean) * -1.9,
    y = length(response_labels) / 2 + 0.5,
    label = paste0("Grand Mean ≈ ", round(grand_mean, 2)),
    color = "#F72585",
    hjust = 1,
    size = 10,
    fontface = "bold"
  ) +

  # Arrow pointing to grand mean line
  annotate(
    "segment",
    x = min(covid_summary_by_response$centered_mean) * -1.1,
    xend = 0,
    y = length(response_labels) / 2 + 0.3,
    yend = length(response_labels) / 2,
    color = "#F72585",
    arrow = arrow(length = unit(0.2, "cm")),
    size = 1
  ) +

  # Add top axis with actual Likert scale labels
  scale_x_continuous(
    name = "Centered Mean Likert Score",
    sec.axis = sec_axis(
      trans = ~ . + grand_mean,
      name = "Likert Scale",
      breaks = 1:5 - grand_mean,
      labels = paste0(
        names(likert_scores), "\n", likert_scores
      )
    )
  ) +

  labs(
    title = "Centered Likert Score by Survey Question",
    subtitle = "Bars show deviation from grand mean Likert score across all questions",
    y = NULL
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(size = 17),
    axis.text.x.top = element_text(size = 14, color = "gray20"),
    axis.title.x.top = element_text(size = 14, face = "italic"),
    axis.title.x = element_text(size = 16)
  )

# Print the plot
print(g_diverge)


```
<div class="note-box">
<b>Note:</b><br>
Data for this graph was taken from the 25th-75th percentile wrangled data.
</div>

<div class="note-box">
<b>Q5a ....alt text description</b><br>
Alt text: A diverging bar chart visualizes Likert-scale responses to six COVID-19 vaccine-related statements. Each statement is represented by a horizontal bar segmented by response categories: strongly disagree, disagree, neutral, agree, strongly agree, and NA, each in a distinct color. The x-axis shows a centered scale ranging from -60 to 60, indicating deviation from the mean response, scaled by percent. Statements include concerns about safety, trust in vaccine information, and willingness to recommend vaccination. The chart reveals variation in sentiment and notable asymmetries across response patterns.
</div>

<div class="question-box">
<b>Q5b ....</b><br>
COVID survey - another view. Create two bar charts of the Likert data for the six survey questions in from the plot in Exercise 2. This should be a single plot visualizing the percentages of each possible answer, with different questions on the y-axis. Use an appropriate color scale.<br>
<b>b. Create a 100% bar chart</b>
<br><b>Write alt text for your visualization as well.</b>
</div>

```{r}
#| label: label-me-5b
#| fig.width: 8   # width in inches
#| fig.height: 10   # height in inches
# We start from covid_survey_longer and get proportions by explanatory & response

library(dplyr)
library(ggplot2)

# Step 1: Summarize all response distributions
all_response_dists <- covid_survey_longer |>
  filter(response %in% names(response_labels)) |>
  group_by(response, response_value) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(response) |>
  mutate(percent = n / sum(n)) |>
  ungroup()

# Step 2: Plot with one bar per response question (faceted or stacked)
g5 <- # Response labels (readable, with line breaks)
response_labels <- c(
  resp_safety = "Vaccine is safe",
  resp_feel_safe_at_work = "Feel safer\nat work",
  resp_concern_safety = "Concern about\nvaccine safety",
  resp_confidence_science = "Confidence in\nscientific vetting",
  resp_trust_info = "Trust in\nvaccine info",
  resp_will_recommend = "Will recommend\nvaccine"
)

# Likert response labels
likert_scores <- c(
  "1" = "Strongly Agree", 
  "2" = "Somewhat Agree", 
  "3" = "Neither Agree Nor Disagree", 
  "4" = "Somewhat Disagree", 
  "5" = "Strongly Disagree"
)

# Summarize overall response distribution
all_response_dists <- covid_survey_longer |>
  filter(response %in% names(response_labels)) |>
  group_by(response, response_value) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(response) |>
  mutate(percent = n / sum(n)) |>
  ungroup() |>
  mutate(response = factor(response, levels = names(response_labels), labels = response_labels[ names(response_labels) ]))

# Plot: horizontal stacked bars
g5 <- ggplot(all_response_dists, aes(y = response, x = percent, fill = factor(response_value))) +
  geom_col(width = 0.6) +
  #scale_x_continuous(labels = scales::percent_format()) +
  scale_fill_manual(
    values = my_turquoise_to_yellow,
    labels = likert_scores,
    name = "Likert Response"
  ) +
  labs(
    x = "Percentage",
    y = NULL,
    title = "Overall Survey Response Distribution",
    subtitle = "Horizontal 100% Stacked Bar Chart for All Questions"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold")
  )

plot(g5)

```
<div class="note-box">
<b>Q5b ....alt text description</b><br>
Alt text: A 100% stacked bar chart displays Likert-scale survey responses to six statements about COVID-19 vaccines. Each bar corresponds to a different statement, such as “Concern about vaccine safety” and “Will recommend vaccine.” The bars are divided into color-coded segments representing response options: Strongly disagree (light blue), Disagree (orange), Neutral (yellow), Agree (red), Strongly agree (dark blue), and NA (gray). The x-axis shows percentage values from 0 to 100%, allowing for comparison of relative agreement across the questions. The chart highlights variation in public sentiment—some questions skew toward strong agreement, while others show more mixed or polarized responses.
</div>

